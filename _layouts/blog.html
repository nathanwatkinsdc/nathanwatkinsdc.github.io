<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page.title }}</title>
    <link rel="stylesheet" href="/assets/style.css">
</head>
<body>

    <!-- Navbar -->
    <nav>
        <div class="nav-container">
            <div class="nav-title">Nathan Watkins</div>
            <ul class="nav-links">
                <li><a href="/">Home</a></li>
                <li><a href="/blog/">Blog</a></li>
                <li><a href="/resume/">Resume</a></li>
                <li><a href="/links/">Links</a></li>
            </ul>
        </div>
    </nav>

    <!-- Blog Section -->
    <main>
        <h1 class="text-center">‚úçüèª My Blog </h1>

        <!-- horizontal line -->
        <hr />

        <div class="blog-layout">
            <!-- Sidebar for tag filtering -->
            <aside class="blog-sidebar">
                <h3>Filter by Topic</h3>
                <div class="tag-filter-container">
                    <div class="tag-filter active" data-tag="all">
                        <span class="tag-name">All Posts</span>
                        <span class="tag-count" id="all-count">0</span>
                    </div>
                    <div id="tag-filters"></div>
                </div>
            </aside>

            <!-- Main content area -->
            <div class="blog-main">
                <!-- Search Bar -->
                <div class="search-container">
                    <input type="text" id="search-input" placeholder="Search blog posts..." class="search-input">
                    <div id="search-results" class="search-results"></div>
                </div>

                <!-- Posts per page selector -->
                <div class="posts-control">
                    <label for="posts-per-page">Show: </label>
                    <select id="posts-per-page">
                        <option value="5">5 posts</option>
                        <option value="10">10 posts</option>
                        <option value="all">All posts</option>
                    </select>
                </div>

                <div class="blog-container" id="blog-container">
                    {% for post in site.posts %}
                        <div class="blog-card" data-title="{{ post.title | downcase }}" data-description="{{ post.description | downcase }}" data-tags="{% for tag in post.tags %}{{ tag | downcase }} {% endfor %}" data-index="{{ forloop.index0 }}">
                            <div class="blog-thumbnail-container">
                                <a href="{{ post.url }}">
                                    <img src="{{ post.thumbnail | default: '/assets/images/default-thumbnail.jpg' }}" 
                                         alt="{{ post.title }}" class="blog-thumbnail">
                                </a>
                            </div>
                            <div class="blog-details">
                                <h2>
                                    <a href="{{ post.url }}">{{ post.title }}</a>
                                </h2>
                                <p class="blog-date">{{ post.date | date: "%B %d, %Y" }}</p>
                                <p>{{ post.description | default: "No description available." }}</p>
                                {% if post.tags %}
                                    <div class="blog-tags">
                                        {% for tag in post.tags %}
                                            <span class="blog-tag clickable-tag" data-tag="{{ tag | downcase }}">#{{ tag }}</span>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <a href="{{ post.url }}" class="read-more">Read More ‚Üí</a>
                            </div>
                        </div>
                    {% endfor %}
                </div>

                <!-- Load More Button -->
                <div class="load-more-container" id="load-more-container">
                    <button id="load-more-btn" class="load-more-btn">Load More Posts</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Enhanced JavaScript with Tag Filtering -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Blog script starting...');
            
            // Get all elements
            const searchInput = document.getElementById('search-input');
            const searchResults = document.getElementById('search-results');
            const blogContainer = document.getElementById('blog-container');
            const blogCards = Array.from(document.querySelectorAll('.blog-card'));
            const postsPerPageSelect = document.getElementById('posts-per-page');
            const loadMoreBtn = document.getElementById('load-more-btn');
            const loadMoreContainer = document.getElementById('load-more-container');
            const tagFiltersContainer = document.getElementById('tag-filters');
            const allCountSpan = document.getElementById('all-count');
            
            console.log(`Found ${blogCards.length} blog cards`);
            
            // Check if elements exist
            if (!searchInput || !blogContainer || blogCards.length === 0) {
                console.error('Missing required elements');
                return;
            }
            
            let currentlyVisible = 5;
            let totalPosts = blogCards.length;
            let filteredCards = [...blogCards]; // Create a copy
            let activeTag = 'all';
            let searchTimeout;

            // Initialize everything
            try {
                initializeTagFilters();
                updateDisplay();
                console.log('Initialization complete');
            } catch (error) {
                console.error('Initialization error:', error);
            }

            // Initialize tag filters
            function initializeTagFilters() {
                if (!tagFiltersContainer || !allCountSpan) {
                    console.log('Tag filter elements not found, skipping tag functionality');
                    return;
                }
                
                const tagCounts = {};
                
                // Count occurrences of each tag
                blogCards.forEach(card => {
                    const tags = card.dataset.tags ? card.dataset.tags.trim() : '';
                    if (tags) {
                        tags.split(' ').forEach(tag => {
                            if (tag && tag.length > 0) {
                                tagCounts[tag] = (tagCounts[tag] || 0) + 1;
                            }
                        });
                    }
                });

                console.log('Tag counts:', tagCounts);

                // Sort tags by count (descending)
                const sortedTags = Object.entries(tagCounts)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 10); // Show top 10 tags

                // Update "All Posts" count
                allCountSpan.textContent = totalPosts;

                // Create tag filter elements
                sortedTags.forEach(([tag, count]) => {
                    const tagFilter = document.createElement('div');
                    tagFilter.className = 'tag-filter';
                    tagFilter.dataset.tag = tag;
                    tagFilter.innerHTML = `
                        <span class="tag-name">#${tag}</span>
                        <span class="tag-count">${count}</span>
                    `;
                    tagFiltersContainer.appendChild(tagFilter);
                });

                // Add click handlers to all tag filters
                document.querySelectorAll('.tag-filter').forEach(filter => {
                    filter.addEventListener('click', function() {
                        const tag = this.dataset.tag;
                        setActiveTag(tag);
                    });
                });
            }

            // Set active tag filter
            function setActiveTag(tag) {
                console.log('Setting active tag:', tag);
                activeTag = tag;
                
                // Update active states
                document.querySelectorAll('.tag-filter').forEach(filter => {
                    filter.classList.remove('active');
                });
                const activeFilter = document.querySelector(`[data-tag="${tag}"]`);
                if (activeFilter) {
                    activeFilter.classList.add('active');
                }

                // Clear search when filtering by tag
                if (searchInput) {
                    searchInput.value = '';
                }
                if (searchResults) {
                    searchResults.style.display = 'none';
                }

                // Filter cards by tag
                if (tag === 'all') {
                    filteredCards = [...blogCards];
                } else {
                    filteredCards = blogCards.filter(card => {
                        const tags = card.dataset.tags ? card.dataset.tags.trim() : '';
                        return tags.split(' ').includes(tag);
                    });
                }

                currentlyVisible = 5;
                updateDisplay();
            }

            // Make blog tags clickable
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('clickable-tag')) {
                    const tag = e.target.dataset.tag;
                    if (tag) {
                        setActiveTag(tag);
                        
                        // Smooth scroll to top of blog section
                        const blogMain = document.querySelector('.blog-main');
                        if (blogMain) {
                            blogMain.scrollIntoView({ 
                                behavior: 'smooth',
                                block: 'start'
                            });
                        }
                    }
                }
            });

            // Posts per page selector
            if (postsPerPageSelect) {
                postsPerPageSelect.addEventListener('change', function() {
                    const value = this.value;
                    if (value === 'all') {
                        showAllPosts();
                    } else {
                        currentlyVisible = parseInt(value);
                        updateDisplay();
                    }
                });
            }

            // Load more functionality
            if (loadMoreBtn) {
                loadMoreBtn.addEventListener('click', function() {
                    currentlyVisible += 5;
                    updateDisplay();
                });
            }

            // Search functionality
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        const searchTerm = this.value.toLowerCase().trim();
                        console.log('Searching for:', searchTerm);
                        
                        if (searchTerm === '') {
                            // Return to current tag filter when search is cleared
                            if (activeTag === 'all') {
                                filteredCards = [...blogCards];
                            } else {
                                filteredCards = blogCards.filter(card => {
                                    const tags = card.dataset.tags ? card.dataset.tags.trim() : '';
                                    return tags.split(' ').includes(activeTag);
                                });
                            }
                            if (searchResults) {
                                searchResults.style.display = 'none';
                            }
                        } else {
                            // Search within current tag filter
                            let baseCards = activeTag === 'all' ? blogCards : blogCards.filter(card => {
                                const tags = card.dataset.tags ? card.dataset.tags.trim() : '';
                                return tags.split(' ').includes(activeTag);
                            });

                            filteredCards = baseCards.filter(card => {
                                const title = card.dataset.title || '';
                                const description = card.dataset.description || '';
                                const tags = card.dataset.tags || '';
                                
                                return title.includes(searchTerm) || 
                                       description.includes(searchTerm) || 
                                       tags.includes(searchTerm);
                            });
                            
                            if (searchResults) {
                                const tagContext = activeTag === 'all' ? '' : ` in #${activeTag}`;
                                searchResults.innerHTML = `Found ${filteredCards.length} post${filteredCards.length !== 1 ? 's' : ''} matching "${searchTerm}"${tagContext}`;
                                searchResults.style.display = 'block';
                            }
                        }
                        
                        currentlyVisible = 5;
                        updateDisplay();
                    }, 300);
                });
            }

            function updateDisplay() {
                console.log(`Updating display: showing ${Math.min(currentlyVisible, filteredCards.length)} of ${filteredCards.length} posts`);
                
                // Hide all cards first
                blogCards.forEach(card => {
                    card.style.display = 'none';
                });
                
                // Show filtered cards up to currentlyVisible
                filteredCards.slice(0, currentlyVisible).forEach(card => {
                    card.style.display = 'flex';
                });

                // Update load more button
                if (loadMoreContainer && loadMoreBtn) {
                    if (currentlyVisible >= filteredCards.length) {
                        loadMoreContainer.style.display = 'none';
                    } else {
                        loadMoreContainer.style.display = 'block';
                        loadMoreBtn.textContent = `Load More (${filteredCards.length - currentlyVisible} remaining)`;
                    }
                }
            }

            function showAllPosts() {
                filteredCards.forEach(card => {
                    card.style.display = 'flex';
                });
                if (loadMoreContainer) {
                    loadMoreContainer.style.display = 'none';
                }
            }

            // Debug: Check if posts are being found
            if (totalPosts === 0) {
                blogContainer.innerHTML = '<p style="text-align: center; color: #666; font-style: italic;">No blog posts found. Make sure your posts are in the _posts directory and have proper front matter.</p>';
            }
        });
    </script>

</body>
</html>
