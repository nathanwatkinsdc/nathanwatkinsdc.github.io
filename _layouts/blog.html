<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page.title }}</title>
    <link rel="stylesheet" href="/assets/style.css">
</head>
<body>

    <!-- Navbar -->
    <nav>
        <div class="nav-container">
            <div class="nav-title">Nathan Watkins</div>
            <ul class="nav-links">
                <li><a href="/">Home</a></li>
                <li><a href="/blog/">Blog</a></li>
                <li><a href="/resume/">Resume</a></li>
                <li><a href="/links/">Links</a></li>
            </ul>
        </div>
    </nav>

    <!-- Blog Section -->
    <main>
        <h1 class="text-center">‚úçüèª My Blog </h1>

        <!-- horizontal line -->
        <hr />

        <div class="blog-layout">
            <div class="blog-main">

                <!-- Tag Filter Section -->
                <div class="tag-filter-section">
                    <div class="tag-filter-header">
                        <h4>Filter by Topic:</h4>
                        <button id="toggle-tags" class="toggle-tags-btn">Hide ‚ñ≤</button>
                    </div>

                    <!-- IMPORTANT: All Posts first, then dynamic tags -->
                    <div class="tag-filter-container" id="tag-filter-container">
                        <div class="tag-filter active" data-tag="all">
                            <span class="tag-name">All Posts</span>
                            <span class="tag-count" id="all-count">0</span>
                        </div>
                        <!-- <div id="tag-filters"></div> NOT USING THIS CODE MAKES EACH TAG A GRID ITEM VS WRAPPED BLOCK -->
                    </div>
                </div>
                
                <!-- Controls Row (search + posts-per-page) -->
                <div class="controls-bar">
                    <div class="search-container">
                        <input type="text" id="search-input" placeholder="Search blog posts..." class="search-input">
                        <div id="search-results" class="search-results"></div>
                    </div>

                    <div class="posts-control">
                        <label for="posts-per-page">Show:</label>
                        <select id="posts-per-page">
                            <option value="5">5 posts</option>
                            <option value="10">10 posts</option>
                            <option value="all">All posts</option>
                        </select>
                    </div>
                </div>

                <div class="blog-container" id="blog-container">
                    {% for post in site.posts %}
                        <div class="blog-card" data-title="{{ post.title | downcase }}" data-description="{{ post.description | downcase }}" data-tags="{% for tag in post.tags %}{{ tag | downcase }} {% endfor %}" data-index="{{ forloop.index0 }}">
                            <div class="blog-thumbnail-container">
                                <a href="{{ post.url }}">
                                    <img src="{{ post.thumbnail | default: '/assets/images/default-thumbnail.jpg' }}" 
                                         alt="{{ post.title }}" class="blog-thumbnail">
                                </a>
                            </div>
                            <div class="blog-details">
                                <h2>
                                    <a href="{{ post.url }}">{{ post.title }}</a>
                                </h2>
                                <p class="blog-date">{{ post.date | date: "%B %d, %Y" }}</p>
                                <p>{{ post.description | default: "No description available." }}</p>
                                {% if post.tags %}
                                    <div class="blog-tags">
                                        {% for tag in post.tags %}
                                            <span class="blog-tag clickable-tag" data-tag="{{ tag | downcase }}">#{{ tag }}</span>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <a href="{{ post.url }}" class="read-more">Read More ‚Üí</a>
                            </div>
                        </div>
                    {% endfor %}
                </div>

                <!-- Load More Button -->
                <div class="load-more-container" id="load-more-container">
                    <button id="load-more-btn" class="load-more-btn">Load More Posts</button>
                </div>
            </div>
        </div>
    </main>

    <!-- JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Blog script starting...');
            
            const searchInput = document.getElementById('search-input');
            const searchResults = document.getElementById('search-results');
            const blogContainer = document.getElementById('blog-container');
            const blogCards = Array.from(document.querySelectorAll('.blog-card'));
            const postsPerPageSelect = document.getElementById('posts-per-page');
            const loadMoreBtn = document.getElementById('load-more-btn');
            const loadMoreContainer = document.getElementById('load-more-container');

            const tagContainer = document.getElementById('tag-filter-container');
            const tagFilters = document.getElementById('tag-filters'); // inner container for dynamic tags
            const allCountSpan = document.getElementById('all-count');
            
            console.log(`Found ${blogCards.length} blog cards`);
            
            if (!searchInput || !blogContainer || blogCards.length === 0) {
                console.error('Missing required elements');
                return;
            }
            
            let currentlyVisible = 5;
            const totalPosts = blogCards.length;
            let filteredCards = [...blogCards];
            let activeTag = 'all';
            let searchTimeout;

            try {
                initializeTagFilters();
                initializeToggleButton();
                updateDisplay();
                console.log('Initialization complete');
            } catch (error) {
                console.error('Initialization error:', error);
            }

            function initializeToggleButton() {
                const toggleBtn = document.getElementById('toggle-tags');
                if (toggleBtn && tagContainer) {
                    toggleBtn.addEventListener('click', function() {
                        const isHidden = tagContainer.style.display === 'none';
                        if (isHidden) {
                            tagContainer.style.display = 'grid'; // grid, not flex
                            toggleBtn.textContent = 'Hide ‚ñ≤';
                        } else {
                            tagContainer.style.display = 'none';
                            toggleBtn.textContent = 'Show ‚ñº';
                        }
                    });
                }
            }

            function initializeTagFilters() {
                if (!tagContainer || !allCountSpan) {
                    console.log('Tag filter elements not found, skipping tag functionality');
                    return;
                }
                
                const tagCounts = {};
                
                blogCards.forEach(card => {
                    const tags = (card.dataset.tags || '').trim();
                    if (tags) {
                        tags.split(' ').forEach(tag => {
                            if (tag) tagCounts[tag] = (tagCounts[tag] || 0) + 1;
                        });
                    }
                });

                const sortedTags = Object.entries(tagCounts)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 10);

                allCountSpan.textContent = totalPosts;

                // Append dynamic tags AFTER the "All Posts" chip
                
                // old - add chips to the wrapper
                // const target = tagFilters || tagContainer;

                // new - add chips to the grid, not to the wrapper
                // making each chip a direct child of the grid >> ...
                // ... the container can pack items top -> bottom, then left -> right across four columns
                // ... without that wrapper forcing the first column to be full width
                const target = tagContainer
                
                sortedTags.forEach(([tag, count]) => {
                    const tagFilter = document.createElement('div');
                    tagFilter.className = 'tag-filter';
                    tagFilter.dataset.tag = tag;
                    tagFilter.innerHTML = `
                        <span class="tag-name">#${tag}</span>
                        <span class="tag-count">${count}</span>
                    `;
                    target.appendChild(tagFilter);
                });

                // Column-wise packing: set number of rows for 4 columns
                const totalChips = 1 /* All Posts */ + sortedTags.length;
                const columns = 4;
                const rows = Math.ceil(totalChips / columns);
                tagContainer.style.gridTemplateRows = `repeat(${rows}, minmax(min-content, max-content))`;

                // Click handlers
                document.querySelectorAll('.tag-filter').forEach(filter => {
                    filter.addEventListener('click', function() {
                        const tag = this.dataset.tag;
                        setActiveTag(tag);
                    });
                });
            }

            function setActiveTag(tag) {
                console.log('Setting active tag:', tag);
                activeTag = tag;
                
                document.querySelectorAll('.tag-filter').forEach(filter => {
                    filter.classList.remove('active');
                });
                const activeFilter = document.querySelector(`[data-tag="${tag}"]`);
                if (activeFilter) activeFilter.classList.add('active');

                if (searchInput) searchInput.value = '';
                if (searchResults) searchResults.style.display = 'none';

                if (tag === 'all') {
                    filteredCards = [...blogCards];
                } else {
                    filteredCards = blogCards.filter(card => {
                        const tags = (card.dataset.tags || '').trim();
                        return tags.split(' ').includes(tag);
                    });
                }

                currentlyVisible = 5;
                updateDisplay();
            }

            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('clickable-tag')) {
                    const tag = e.target.dataset.tag;
                    if (tag) {
                        setActiveTag(tag);
                        const blogMain = document.querySelector('.blog-main');
                        if (blogMain) {
                            blogMain.scrollIntoView({ 
                                behavior: 'smooth',
                                block: 'start'
                            });
                        }
                    }
                }
            });

            if (postsPerPageSelect) {
                postsPerPageSelect.addEventListener('change', function() {
                    const value = this.value;
                    if (value === 'all') {
                        showAllPosts();
                    } else {
                        currentlyVisible = parseInt(value);
                        updateDisplay();
                    }
                });
            }

            if (loadMoreBtn) {
                loadMoreBtn.addEventListener('click', function() {
                    currentlyVisible += 5;
                    updateDisplay();
                });
            }

            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        const searchTerm = this.value.toLowerCase().trim();
                        console.log('Searching for:', searchTerm);
                        
                        if (searchTerm === '') {
                            filteredCards = (activeTag === 'all')
                                ? [...blogCards]
                                : blogCards.filter(card => {
                                    const tags = (card.dataset.tags || '').trim();
                                    return tags.split(' ').includes(activeTag);
                                  });
                            if (searchResults) searchResults.style.display = 'none';
                        } else {
                            const baseCards = (activeTag === 'all')
                                ? blogCards
                                : blogCards.filter(card => {
                                    const tags = (card.dataset.tags || '').trim();
                                    return tags.split(' ').includes(activeTag);
                                  });

                            filteredCards = baseCards.filter(card => {
                                const title = card.dataset.title || '';
                                const description = card.dataset.description || '';
                                const tags = card.dataset.tags || '';
                                return title.includes(searchTerm) || 
                                       description.includes(searchTerm) || 
                                       tags.includes(searchTerm);
                            });
                            
                            if (searchResults) {
                                const tagContext = activeTag === 'all' ? '' : ` in #${activeTag}`;
                                searchResults.innerHTML = `Found ${filteredCards.length} post${filteredCards.length !== 1 ? 's' : ''} matching "${searchTerm}"${tagContext}`;
                                searchResults.style.display = 'block';
                            }
                        }
                        
                        currentlyVisible = 5;
                        updateDisplay();
                    }, 300);
                });
            }

            function updateDisplay() {
                console.log(`Updating display: showing ${Math.min(currentlyVisible, filteredCards.length)} of ${filteredCards.length} posts`);
                
                blogCards.forEach(card => { card.style.display = 'none'; });
                filteredCards.slice(0, currentlyVisible).forEach(card => {
                    card.style.display = 'flex';
                });

                if (loadMoreContainer && loadMoreBtn) {
                    if (currentlyVisible >= filteredCards.length) {
                        loadMoreContainer.style.display = 'none';
                    } else {
                        loadMoreContainer.style.display = 'block';
                        loadMoreBtn.textContent = `Load More (${filteredCards.length - currentlyVisible} remaining)`;
                    }
                }
            }

            function showAllPosts() {
                filteredCards.forEach(card => { card.style.display = 'flex'; });
                if (loadMoreContainer) loadMoreContainer.style.display = 'none';
            }

            if (totalPosts === 0) {
                blogContainer.innerHTML = '<p style="text-align: center; color: #666; font-style: italic;">No blog posts found. Make sure your posts are in the _posts directory and have proper front matter.</p>';
            }
        });
    </script>

</body>
</html>
